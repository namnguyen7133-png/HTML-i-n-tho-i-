<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tính Can Chi chuẩn theo LỊCH ÂM</title>
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --light-color: #ecf0f1;
        --dark-color: #2c3e50;
        --lunar-bg: #fff8e1;
        --year-color: #c0392b;
        --month-color: #2980b9;
        --day-color: #27ae60;
        --hour-color: #8e44ad;
        --border-radius: 10px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark-color);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .container {
        max-width: 900px;
        width: 100%;
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(to right, #f46b45, #eea849);
    }
    
    header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--light-color);
    }
    
    h1 {
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 2.2rem;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .subtitle {
        color: #7f8c8d;
        font-size: 1rem;
    }
    
    .input-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
        .input-section {
            grid-template-columns: 1fr;
        }
    }
    
    .input-group {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1rem;
    }
    
    input, select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
    
    button {
        padding: 14px 25px;
        border: none;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    #calcBtn {
        background: linear-gradient(to right, #3498db, #2980b9);
        color: white;
    }
    
    #calcBtn:hover {
        background: linear-gradient(to right, #2980b9, #1c6ea4);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
    }
    
    #todayBtn {
        background: linear-gradient(to right, #2ecc71, #27ae60);
        color: white;
    }
    
    #todayBtn:hover {
        background: linear-gradient(to right, #27ae60, #219653);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
    }
    
    .result-container {
        margin-top: 30px;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .result-header {
        background: linear-gradient(to right, var(--primary-color), #34495e);
        color: white;
        padding: 15px 20px;
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #result {
        padding: 25px;
        min-height: 300px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .lunar-date {
        background-color: var(--lunar-bg);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        text-align: center;
        border: 2px dashed #ffb74d;
    }
    
    .lunar-date h3 {
        color: #e65100;
        margin-bottom: 10px;
        font-size: 1.3rem;
    }
    
    .lunar-date .date-display {
        font-size: 1.8rem;
        font-weight: bold;
        color: #d84315;
    }
    
    .canchi-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
    }
    
    @media (max-width: 600px) {
        .canchi-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .canchi-item {
        padding: 15px;
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .canchi-item:hover {
        transform: translateY(-5px);
    }
    
    .canchi-item.year {
        background: linear-gradient(135deg, #ffcdd2, #ffebee);
        border: 2px solid var(--year-color);
    }
    
    .canchi-item.month {
        background: linear-gradient(135deg, #bbdefb, #e3f2fd);
        border: 2px solid var(--month-color);
    }
    
    .canchi-item.day {
        background: linear-gradient(135deg, #c8e6c9, #e8f5e9);
        border: 2px solid var(--day-color);
    }
    
    .canchi-item.hour {
        background: linear-gradient(135deg, #e1bee7, #f3e5f5);
        border: 2px solid var(--hour-color);
    }
    
    .canchi-label {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #555;
    }
    
    .canchi-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .canchi-item.year .canchi-value {
        color: var(--year-color);
    }
    
    .canchi-item.month .canchi-value {
        color: var(--month-color);
    }
    
    .canchi-item.day .canchi-value {
        color: var(--day-color);
    }
    
    .canchi-item.hour .canchi-value {
        color: var(--hour-color);
    }
    
    .canchi-description {
        font-size: 0.9rem;
        color: #777;
        margin-top: 5px;
    }
    
    .weekday-display {
        background: linear-gradient(135deg, #fff3e0, #fff8e1);
        padding: 15px;
        border-radius: var(--border-radius);
        text-align: center;
        margin-top: 20px;
        border: 2px solid #ffb300;
    }
    
    .weekday-display .label {
        font-size: 1rem;
        color: #ff8f00;
        margin-bottom: 5px;
    }
    
    .weekday-display .value {
        font-size: 1.6rem;
        font-weight: bold;
        color: #f57c00;
    }
    
    .footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .info-note {
        background-color: #e8f4fd;
        padding: 15px;
        border-radius: var(--border-radius);
        margin-top: 20px;
        border-left: 4px solid #3498db;
        font-size: 0.95rem;
        color: #2c3e50;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-moon"></i> Tính Can Chi Chuẩn Theo Lịch Âm</h1>
        <p class="subtitle">Công cụ chuyển đổi ngày dương lịch sang âm lịch và tính Can Chi (năm, tháng, ngày, giờ)</p>
    </header>
    
    <div class="input-section">
        <div class="input-group">
            <label for="solarDate"><i class="fas fa-calendar-alt"></i> Ngày dương lịch</label>
            <input type="date" id="solarDate">
        </div>
        
        <div class="input-group">
            <label for="hourSelect"><i class="fas fa-clock"></i> Giờ (theo hệ 12 canh giờ)</label>
            <select id="hourSelect">
                <option value="0">Tý (23h-1h)</option>
                <option value="2">Sửu (1h-3h)</option>
                <option value="4">Dần (3h-5h)</option>
                <option value="6">Mão (5h-7h)</option>
                <option value="8">Thìn (7h-9h)</option>
                <option value="10">Tỵ (9h-11h)</option>
                <option value="12">Ngọ (11h-13h)</option>
                <option value="14">Mùi (13h-15h)</option>
                <option value="16">Thân (15h-17h)</option>
                <option value="18">Dậu (17h-19h)</option>
                <option value="20">Tuất (19h-21h)</option>
                <option value="22">Hợi (21h-23h)</option>
            </select>
        </div>
    </div>
    
    <div class="btn-group">
        <button id="calcBtn" onclick="calc()">
            <i class="fas fa-calculator"></i> Tính Can Chi
        </button>
        <button id="todayBtn" onclick="setToday()">
            <i class="fas fa-calendar-day"></i> Hôm nay
        </button>
    </div>
    
    <div class="result-container">
        <div class="result-header">
            <i class="fas fa-chart-pie"></i> Kết Quả Tính Toán
        </div>
        <div id="result">
            <div class="info-note">
                <i class="fas fa-info-circle"></i> Chọn ngày dương lịch và giờ, sau đó nhấn "Tính Can Chi" để xem kết quả.
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2023 Công cụ Tính Can Chi theo Lịch Âm | Dựa trên thuật toán Hoàng Ngọc Đức</p>
    </div>
</div>

<script>
/* ===== HỆ CAN CHI ===== */
const CAN = ['Giáp', 'Ất', 'Bính', 'Đinh', 'Mậu', 'Kỷ', 'Canh', 'Tân', 'Nhâm', 'Quý'];
const CHI = ['Tý', 'Sửu', 'Dần', 'Mão', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi', 'Thân', 'Dậu', 'Tuất', 'Hợi'];
const CHI_MONTH = ['Dần', 'Mão', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi', 'Thân', 'Dậu', 'Tuất', 'Hợi', 'Tý', 'Sửu'];

/* ===== HÀM TÍNH TOÁN CƠ BẢN ===== */
function jdFromDate(dd, mm, yy) {
    if (mm <= 2) {
        yy--;
        mm += 12;
    }
    let A = Math.floor(yy / 100);
    let B = 2 - A + Math.floor(A / 4);
    return Math.floor(365.25 * (yy + 4716)) + Math.floor(30.6001 * (mm + 1)) + dd + B - 1524;
}

/* ===== THUẬT TOÁN ÂM LỊCH HOÀNG NGỌC ĐỨC ===== */
const PI = Math.PI;

// Tính thời điểm Sóc (New Moon)
function NewMoon(k) {
    let T = k / 1236.85;
    let T2 = T * T;
    let T3 = T2 * T;
    let dr = PI / 180;
    
    let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
    Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
    
    let M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
    let Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
    let F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
    
    let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr);
    C1 = C1 + 0.0021 * Math.sin(2 * dr * M);
    C1 = C1 - 0.4068 * Math.sin(Mpr * dr);
    C1 = C1 + 0.0161 * Math.sin(2 * dr * Mpr);
    C1 = C1 - 0.0004 * Math.sin(3 * dr * Mpr);
    C1 = C1 + 0.0104 * Math.sin(2 * dr * F);
    C1 = C1 - 0.0051 * Math.sin(dr * (M + Mpr));
    C1 = C1 - 0.0074 * Math.sin(dr * (M - Mpr));
    C1 = C1 + 0.0004 * Math.sin(dr * (2 * F + M));
    C1 = C1 - 0.0004 * Math.sin(dr * (2 * F - M));
    C1 = C1 - 0.0006 * Math.sin(dr * (2 * F + Mpr));
    C1 = C1 + 0.0010 * Math.sin(dr * (2 * F - Mpr));
    C1 = C1 + 0.0005 * Math.sin(dr * (2 * Mpr + M));
    
    let deltaT;
    if (T < -11) {
        deltaT = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
    } else {
        deltaT = -0.000278 + 0.000265 * T + 0.000262 * T2;
    }
    
    return Jd1 + C1 - deltaT;
}

// Lấy ngày Sóc
function getNewMoonDay(k, timeZone) {
    return Math.floor(NewMoon(k) + 0.5 + timeZone / 24);
}

// Tính kinh độ mặt trời
function getSunLongitude(jdn, timeZone) {
    let T = (jdn - 2451545.5 - timeZone / 24) / 36525;
    let M = 357.52910 + 35999.05030 * T - 0.0001559 * T * T - 0.00000048 * T * T * T;
    let L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T * T;
    let DL = (1.914600 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M * PI / 180);
    DL = DL + (0.019993 - 0.000101 * T) * Math.sin(2 * M * PI / 180) + 0.000290 * Math.sin(3 * M * PI / 180);
    let L = (L0 + DL) * PI / 180;
    L = L - 2 * PI * Math.floor(L / (2 * PI));
    return Math.floor(L / (PI / 6));
}

// Tìm ngày bắt đầu tháng 11 âm lịch
function getLunarMonth11(yy, timeZone) {
    let off = jdFromDate(31, 12, yy) - 2415021;
    let k = Math.floor(off / 29.530588853);
    let nm = getNewMoonDay(k, timeZone);
    let sunLong = getSunLongitude(nm, timeZone);
    
    if (sunLong >= 9) {
        nm = getNewMoonDay(k - 1, timeZone);
    }
    return nm;
}

// Kiểm tra tháng nhuận
function getLeapMonthOffset(a11, timeZone) {
    let k = Math.floor((a11 - 2415021) / 29.530588853);
    let last;
    let i = 1;
    let arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    
    do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    } while (arc != last && i < 14);
    
    return i - 1;
}

// Chuyển đổi dương lịch sang âm lịch
function solarToLunar(dd, mm, yy, timeZone) {
    let dayNumber = jdFromDate(dd, mm, yy);
    let k = Math.floor((dayNumber - 2415021) / 29.530588853);
    let monthStart = getNewMoonDay(k + 1, timeZone);
    
    if (monthStart > dayNumber) {
        monthStart = getNewMoonDay(k, timeZone);
    }
    
    let a11 = getLunarMonth11(yy, timeZone);
    let b11 = a11;
    
    let lunarYear;
    if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, timeZone);
    } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, timeZone);
    }
    
    let lunarDay = dayNumber - monthStart + 1;
    let diff = Math.floor((monthStart - a11) / 29);
    let lunarLeap = 0;
    let lunarMonth = diff + 11;
    
    if (b11 - a11 > 365) {
        let leapMonthDiff = getLeapMonthOffset(a11, timeZone);
        if (diff >= leapMonthDiff) {
            lunarMonth = diff + 10;
            if (diff == leapMonthDiff) {
                lunarLeap = 1;
            }
        }
    }
    
    if (lunarMonth > 12) {
        lunarMonth = lunarMonth - 12;
    }
    
    if (lunarMonth >= 11 && diff < 4) {
        lunarYear = lunarYear - 1;
    }
    
    return [lunarDay, lunarMonth, lunarYear, lunarLeap];
}

/* ===== HÀM TÍNH CAN CHI ===== */
function calculateCanChi(y, m, d, h) {
    let timeZone = 7; // Múi giờ Việt Nam (UTC+7)
    
    // Chuyển sang âm lịch
    let lunar = solarToLunar(d, m, y, timeZone);
    let [ld, lm, ly, ll] = lunar;
    
    // Tính Julian Day
    let jd = jdFromDate(d, m, y);
    
    // 1. CAN CHI NĂM
    let yearCanIndex = (ly + 6) % 10;
    let yearChiIndex = (ly + 8) % 12;
    let yearCanChi = CAN[yearCanIndex] + ' ' + CHI[yearChiIndex];
    
    // 2. CAN CHI THÁNG
    // Tháng âm lịch bắt đầu từ tháng Dần (tháng 1 âm lịch = Dần)
    let monthChiIndex = (lm - 1) % 12;
    let monthChi = CHI_MONTH[monthChiIndex];
    
    // Tính Can của tháng: (Năm Can * 2 + tháng) % 10
    let monthCanIndex = ((yearCanIndex * 2) + lm) % 10;
    let monthCanChi = CAN[monthCanIndex] + ' ' + monthChi;
    
    // 3. CAN CHI NGÀY
    let dayCanIndex = (jd + 9) % 10;
    let dayChiIndex = (jd + 1) % 12;
    let dayCanChi = CAN[dayCanIndex] + ' ' + CHI[dayChiIndex];
    
    // 4. CAN CHI GIỜ
    // Giờ Tý = 23-1h, Sửu = 1-3h, ..., Hợi = 21-23h
    // Chia 2 giờ một: Tý=0, Sửu=2, Dần=4, ...
    let hourChiIndex = Math.floor(h / 2) % 12;
    let hourCanIndex = (dayCanIndex * 2 + hourChiIndex) % 10;
    let hourCanChi = CAN[hourCanIndex] + ' ' + CHI[hourChiIndex];
    
    // 5. THỨ TRONG TUẦN
    const WEEKDAYS = ['Chủ nhật', 'Thứ hai', 'Thứ ba', 'Thứ tư', 'Thứ năm', 'Thứ sáu', 'Thứ bảy'];
    let weekdayIndex = (jd + 1) % 7;
    let weekday = WEEKDAYS[weekdayIndex];
    
    return {
        lunarDate: { day: ld, month: lm, year: ly, leap: ll },
        canChi: {
            year: yearCanChi,
            month: monthCanChi,
            day: dayCanChi,
            hour: hourCanChi
        },
        solarDate: { day: d, month: m, year: y, hour: h },
        weekday: weekday,
        julianDay: jd
    };
}

/* ===== GIAO DIỆN VÀ XỬ LÝ SỰ KIỆN ===== */
function setToday() {
    let today = new Date();
    let yyyy = today.getFullYear();
    let mm = String(today.getMonth() + 1).padStart(2, '0');
    let dd = String(today.getDate()).padStart(2, '0');
    let hh = today.getHours();
    
    document.getElementById('solarDate').value = `${yyyy}-${mm}-${dd}`;
    
    // Chọn giờ tương ứng (làm tròn xuống đến canh giờ gần nhất)
    let hourForSelect = Math.floor(hh / 2) * 2;
    document.getElementById('hourSelect').value = hourForSelect;
    
    // Tính và hiển thị kết quả ngay
    calc();
}

function calc() {
    let dateValue = document.getElementById('solarDate').value;
    if (!dateValue) {
        alert('Vui lòng chọn ngày dương lịch!');
        return;
    }
    
    let [y, m, d] = dateValue.split('-').map(Number);
    let h = parseInt(document.getElementById('hourSelect').value);
    
    // Kiểm tra ngày hợp lệ
    let inputDate = new Date(y, m-1, d);
    if (inputDate.getFullYear() !== y || inputDate.getMonth() !== m-1 || inputDate.getDate() !== d) {
        alert('Ngày không hợp lệ! Vui lòng chọn ngày khác.');
        return;
    }
    
    let result = calculateCanChi(y, m, d, h);
    
    // Định dạng ngày âm lịch
    let lunarDayStr = result.lunarDate.day < 10 ? '0' + result.lunarDate.day : result.lunarDate.day;
    let lunarMonthStr = result.lunarDate.month < 10 ? '0' + result.lunarDate.month : result.lunarDate.month;
    let lunarDateStr = `${lunarDayStr}/${lunarMonthStr}/${result.lunarDate.year}`;
    if (result.lunarDate.leap) {
        lunarDateStr += ' (tháng nhuận)';
    }
    
    // Định dạng ngày dương
    let solarDateStr = `${d}/${m}/${y}`;
    
    // Định dạng giờ
    let hourName = CHI[Math.floor(h/2) % 12];
    let hourRange = '';
    switch(h) {
        case 0: hourRange = '23h-1h'; break;
        case 2: hourRange = '1h-3h'; break;
        case 4: hourRange = '3h-5h'; break;
        case 6: hourRange = '5h-7h'; break;
        case 8: hourRange = '7h-9h'; break;
        case 10: hourRange = '9h-11h'; break;
        case 12: hourRange = '11h-13h'; break;
        case 14: hourRange = '13h-15h'; break;
        case 16: hourRange = '15h-17h'; break;
        case 18: hourRange = '17h-19h'; break;
        case 20: hourRange = '19h-21h'; break;
        case 22: hourRange = '21h-23h'; break;
    }
    
    // Tạo HTML kết quả
    let resultHTML = `
        <div class="lunar-date">
            <h3><i class="fas fa-moon"></i> Ngày Âm Lịch</h3>
            <div class="date-display">${lunarDateStr}</div>
            <p>Tương ứng với ngày dương: ${solarDateStr}</p>
        </div>
        
        <div class="weekday-display">
            <div class="label"><i class="fas fa-calendar-week"></i> Thứ trong tuần</div>
            <div class="value">${result.weekday}</div>
        </div>
        
        <div class="canchi-grid">
            <div class="canchi-item year">
                <div class="canchi-label"><i class="fas fa-calendar"></i> Năm</div>
                <div class="canchi-value">${result.canChi.year}</div>
                <div class="canchi-description">Năm ${result.lunarDate.year} âm lịch</div>
            </div>
            
            <div class="canchi-item month">
                <div class="canchi-label"><i class="fas fa-calendar-alt"></i> Tháng</div>
                <div class="canchi-value">${result.canChi.month}</div>
                <div class="canchi-description">Tháng ${result.lunarDate.month} âm lịch</div>
            </div>
            
            <div class="canchi-item day">
                <div class="canchi-label"><i class="fas fa-sun"></i> Ngày</div>
                <div class="canchi-value">${result.canChi.day}</div>
                <div class="canchi-description">Ngày ${result.lunarDate.day} âm lịch</div>
            </div>
            
            <div class="canchi-item hour">
                <div class="canchi-label"><i class="fas fa-clock"></i> Giờ</div>
                <div class="canchi-value">${result.canChi.hour}</div>
                <div class="canchi-description">Giờ ${hourName} (${hourRange})</div>
            </div>
        </div>
        
        <div class="info-note">
            <i class="fas fa-lightbulb"></i> <strong>Lưu ý:</strong> 
            Can Chi được tính dựa trên âm lịch. Năm và tháng tính theo âm lịch, 
            ngày và giờ tính theo hệ Can Chi 60 hoa giáp.
        </div>
    `;
    
    document.getElementById('result').innerHTML = resultHTML;
}

// Khởi tạo: đặt ngày mặc định là hôm nay
window.onload = function() {
    setToday();
};
</script>
</body>
</html>