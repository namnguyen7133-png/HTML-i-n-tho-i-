<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tính Can Chi chuẩn theo LỊCH ÂM</title>
<style>
body{font-family:Arial;padding:16px}
input,button{margin:6px 0}
#result{border:1px dashed #555;padding:10px;margin-top:12px;min-height:80px}
</style>
</head>
<body>

<h3>Tính Can Chi CHUẨN theo lịch âm</h3>

<input type="date" id="solarDate">
<br>
<button onclick="calc()">Tính Can Chi</button>

<div id="result"></div>

<script>
/* ===== HỆ CAN CHI ===== */
const CAN=['Giáp','Ất','Bính','Đinh','Mậu','Kỷ','Canh','Tân','Nhâm','Quý'];
const CHI=['Tý','Sửu','Dần','Mão','Thìn','Tỵ','Ngọ','Mùi','Thân','Dậu','Tuất','Hợi'];
const CHI_MONTH=['Dần','Mão','Thìn','Tỵ','Ngọ','Mùi','Thân','Dậu','Tuất','Hợi','Tý','Sửu'];

/* ===== JULIAN DAY ===== */
function jdFromDate(dd,mm,yy){
  let a=Math.floor((14-mm)/12);
  let y=yy+4800-a;
  let m=mm+12*a-3;
  return dd+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)-32045;
}

/* ===== ÂM LỊCH (Hoàng Ngọc Đức) ===== */
const PI=Math.PI;
function NewMoon(k){
  let T=k/1236.85;
  let T2=T*T;
  let T3=T2*T;
  let dr=PI/180;
  let Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;
  Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);
  let M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;
  let Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;
  let F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;
  let C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*M*dr);
  C1-=0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*Mpr*dr);
  C1-=0.0004*Math.sin(3*Mpr*dr);
  C1+=0.0104*Math.sin(2*F*dr)-0.0051*Math.sin((M+Mpr)*dr);
  C1-=0.0074*Math.sin((M-Mpr)*dr)+0.0004*Math.sin((2*F+M)*dr);
  C1-=0.0004*Math.sin((2*F-M)*dr)-0.0006*Math.sin((2*F+Mpr)*dr);
  C1+=0.0010*Math.sin((2*F-Mpr)*dr)+0.0005*Math.sin((2*Mpr+M)*dr);
  let deltaT=T< -11?0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3:-0.000278+0.000265*T+0.000262*T2;
  return Jd1+C1-deltaT;
}

function getNewMoonDay(k,tz){return Math.floor(NewMoon(k)+0.5+tz/24)}

function getSunLongitude(jdn,tz){
  let T=(jdn-2451545.5-tz/24)/36525;
  let M=357.52910+35999.05030*T-0.0001559*T*T-0.00000048*T*T*T;
  let L0=280.46645+36000.76983*T+0.0003032*T*T;
  let DL=(1.914600-0.004817*T-0.000014*T*T)*Math.sin(M*PI/180);
  DL+=(0.019993-0.000101*T)*Math.sin(2*M*PI/180)+0.000290*Math.sin(3*M*PI/180);
  let L=(L0+DL)*PI/180;
  return Math.floor(L/(PI/6));
}

function getLunarMonth11(yy,tz){
  let off=jdFromDate(31,12,yy)-2415021;
  let k=Math.floor(off/29.530588853);
  let nm=getNewMoonDay(k,tz);
  if(getSunLongitude(nm,tz)>=9) nm=getNewMoonDay(k-1,tz);
  return nm;
}

function getLeapMonthOffset(a11,tz){
  let k=Math.floor((a11-2415021)/29.530588853);
  let last=0,i=1;
  let arc=getSunLongitude(getNewMoonDay(k+i,tz),tz);
  do{last=arc;i++;arc=getSunLongitude(getNewMoonDay(k+i,tz),tz)}while(arc!=last&&i<14);
  return i-1;
}

function solarToLunar(dd,mm,yy,tz){
  let dayNumber=jdFromDate(dd,mm,yy);
  let k=Math.floor((dayNumber-2415021)/29.530588853);
  let monthStart=getNewMoonDay(k+1,tz);
  if(monthStart>dayNumber) monthStart=getNewMoonDay(k,tz);
  let a11=getLunarMonth11(yy,tz);
  let b11=a11;
  let lunarYear;
  if(a11>=monthStart){lunarYear=yy;a11=getLunarMonth11(yy-1,tz)}else{lunarYear=yy+1;b11=getLunarMonth11(yy+1,tz)}
  let lunarDay=dayNumber-monthStart+1;
  let diff=Math.floor((monthStart-a11)/29);
  let lunarLeap=0;
  let lunarMonth=diff+11;
  if(b11-a11>365){let leapDiff=getLeapMonthOffset(a11,tz);if(diff>=leapDiff){lunarMonth=diff+10;if(diff==leapDiff) lunarLeap=1}}
  if(lunarMonth>12) lunarMonth-=12;
  if(lunarMonth>=11&&diff<4) lunarYear--;
  return [lunarDay,lunarMonth,lunarYear,lunarLeap];
}

/* ===== TÍNH CAN CHI ===== */
function calc(){
  let v=document.getElementById('solarDate').value;
  if(!v) return;
  let [y,m,d]=v.split('-').map(Number);
  let tz=7;
  let lunar=solarToLunar(d,m,y,tz);
  let [ld,lm,ly]=lunar;
  let jd=jdFromDate(d,m,y);

  // Can Chi
  let yearCC=CAN[(ly+6)%10]+' '+CHI[(ly+8)%12];
  let monthCC=CAN[((ly+6)%10*2+lm-1)%10]+' '+CHI_MONTH[lm-1];
  let dayCanIndex=(jd+9)%10;
  let dayChiIndex=(jd+1)%12;
  let dayCC=CAN[dayCanIndex]+' '+CHI[dayChiIndex];

  // Thứ trong tuần
  const WEEK=['Chủ nhật','Thứ hai','Thứ ba','Thứ tư','Thứ năm','Thứ sáu','Thứ bảy'];
  let weekday=WEEK[(jd+1)%7];

  // Giờ hiện tại
  let now=new Date();
  let hour=now.getHours();

  // Can Chi giờ
  let chiHourIndex=Math.floor((hour+1)/2)%12;
  let canHourIndex=(dayCanIndex*2+chiHourIndex)%10;
  let hourCC=CAN[canHourIndex]+' '+CHI[chiHourIndex];

  document.getElementById('result').innerHTML=
    'Âm lịch: '+ld+'/'+lm+'/'+ly+'<br>'+
    'Thứ: '+weekday+'<br>'+
    'Năm: '+yearCC+'<br>'+
    'Tháng: '+monthCC+'<br>'+
    'Ngày: '+dayCC+'<br>'+
    'Giờ hiện tại: '+hour+'h → '+hourCC;
}
</script>

</body>
</html>
