<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phân bổ thu nhập gia đình theo 6 Lọ</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f4f6f8;}
h1 { font-size:20px; margin-bottom:10px; }
.card { background:white; padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
label { display:block; margin-top:8px; font-weight:500; }
input, select { width:100%; padding:6px 8px; margin-top:2px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
button { margin-top:8px; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; color:white; background:#0ea5a4; }
button.warn { background:#f97316; }
table { width:100%; border-collapse:collapse; margin-top:8px; font-size:14px;}
th, td { border-bottom:1px solid #ddd; padding:6px; text-align:left;}
.small { font-size:12px; color:#555; }
.danger { color:#b91c1c; font-weight:600; }
</style>
</head>
<body>

<h1>Phân bổ thu nhập gia đình theo 6 Lọ (Tiếng Việt)</h1>
<div class="card">
  <label>Tổng thu nhập (VND)</label>
  <input type="number" id="income" value="5000000" min="0" />

  <label>Chu kỳ thu nhập</label>
  <select id="period">
    <option value="monthly">Hàng tháng</option>
    <option value="weekly">Hàng tuần</option>
    <option value="yearly">Hàng năm</option>
  </select>

  <label>Danh sách thành viên</label>
  <div id="members" style="margin-bottom:8px;"></div>
  <button onclick="addMember()">+ Thêm thành viên</button>
  <button class="warn" onclick="resetMembers()">Đặt lại 7 thành viên mặc định</button>

  <label>Mục tiêu Chi tiêu cần thiết / người (VND / tháng)</label>
  <input type="number" id="targetEssentialPerPerson" value="600000" />

  <button onclick="calculate()">Tính ngay</button>
</div>

<div id="result" class="card" style="display:none;"></div>

<script>
// ==== Quản lý thành viên ====
function addMember(name='', age=0, role='auto'){
  const container = document.getElementById('members');
  const div = document.createElement('div');
  div.style.marginTop="4px";
  div.innerHTML=`
    <input class="m-name" placeholder="Tên" value="${name}" style="width:120px;">
    <input class="m-age" type="number" min="0" placeholder="Tuổi" value="${age}" style="width:60px;">
    <select class="m-role" style="width:120px;">
      <option value="auto">Tự động (theo tuổi)</option>
      <option value="elder">Người già</option>
      <option value="adult">Người lớn</option>
      <option value="child">Trẻ em</option>
    </select>
    <button style="background:#ef4444;color:white;">X</button>
  `;
  container.appendChild(div);
  div.querySelector('button').onclick=()=>div.remove();
  div.querySelector('.m-role').value=role;
}

function resetMembers(){
  document.getElementById('members').innerHTML='';
  addMember('Cha',80,'elder');
  addMember('Mẹ',45,'adult');
  addMember('Bạn',40,'adult');
  addMember('Con 1',11,'child');
  addMember('Con 2',9,'child');
  addMember('Con 3',5,'child');
  addMember('Vợ',45,'adult');
}

function collectMembers(){
  const rows=Array.from(document.querySelectorAll('#members div'));
  return rows.map(r=>{
    const name = r.querySelector('.m-name').value.trim() || 'Thành viên';
    const age = Number(r.querySelector('.m-age').value)||0;
    let role = r.querySelector('.m-role').value;
    if(role==='auto'){
      if(age>=65) role='elder';
      else if(age<=17) role='child';
      else role='adult';
    }
    return {name, age, role};
  });
}

// ==== Tính toán ====
function calculate(){
  const income = Number(document.getElementById('income').value)||0;
  const period = document.getElementById('period').value;
  const members = collectMembers();
  if(members.length===0){alert('Vui lòng thêm ít nhất 1 thành viên'); return;}
  const targetMonthly = Number(document.getElementById('targetEssentialPerPerson').value)||600000;

  const buckets = {essentials:0.55, education:0.10, savings:0.05, invest:0.05, buffer:0.10, charity:0.05};
  const weightMap = {elder:1.5, child:1.3, adult:1.0};
  const pool={};
  for(const k in buckets) pool[k]=income*buckets[k];

  const memberWeights = members.map(m=>({...m, weight:weightMap[m.role]}));
  const totalWeight = memberWeights.reduce((s,m)=>s+m.weight,0);

  memberWeights.forEach(m=> m.essentials = pool.essentials*(m.weight/totalWeight));

  // Education phân bổ ưu tiên trẻ em
  memberWeights.forEach(m=>{
    let eduPrio = m.role==='child'?1.4:m.role==='elder'?0.4:1.0;
    m.eduPrio=eduPrio;
  });
  const totalEduPrio = memberWeights.reduce((s,m)=>s+m.eduPrio,0);
  memberWeights.forEach(m=> m.education = pool.education*(m.eduPrio/totalEduPrio));

  const essentialsPerPerson = memberWeights.reduce((s,m)=>s+m.essentials,0)/memberWeights.length;

  // Trích tối đa 2% từ từ thiện nếu cần
  const maxCharity = income*0.02;
  let charityTransfer=0;
  if(essentialsPerPerson<targetMonthly){
    const needPerPerson = targetMonthly-essentialsPerPerson;
    const totalNeed = needPerPerson*memberWeights.length;
    charityTransfer = Math.min(maxCharity,totalNeed);
    memberWeights.forEach(m=> m.essentials += charityTransfer*(m.weight/totalWeight));
    pool.essentials+=charityTransfer;
    pool.charity-=charityTransfer;
  }

  // Thu nhập cần thiết theo trọng số
  const requiredIncome = Math.ceil(targetMonthly*totalWeight/buckets.essentials);
  const pctChange = Math.round((requiredIncome-income)/income*100);

  renderResult({income, period, pools:pool, members:memberWeights}, essentialsPerPerson, targetMonthly, charityTransfer, requiredIncome, pctChange);
}

function formatVnd(x){ return isFinite(x)?x.toLocaleString('vi-VN')+' ₫':'—'; }

function renderResult(summary, essentialsPerPerson, targetPerPerson, charityTransfer, requiredIncome, pctChange){
  const div = document.getElementById('result'); div.style.display='block'; div.innerHTML='';

  const poolsHtml = `
    <strong>Khoán các Lọ (VND)</strong>
    <table>
      <tr><td>Chi tiêu cần thiết (Essentials)</td><td>${formatVnd(summary.pools.essentials)}</td></tr>
      <tr><td>Giáo dục (Education)</td><td>${formatVnd(summary.pools.education)}</td></tr>
      <tr><td>Tiết kiệm dài hạn (Savings)</td><td>${formatVnd(summary.pools.savings)}</td></tr>
      <tr><td>Đầu tư / Tự do tài chính (Invest)</td><td>${formatVnd(summary.pools.invest)}</td></tr>
      <tr><td>Dự phòng / Giải trí (Buffer)</td><td>${formatVnd(summary.pools.buffer)}</td></tr>
      <tr><td>Từ thiện (Charity)</td><td>${formatVnd(summary.pools.charity)}</td></tr>
    </table>`;
  div.innerHTML += `<div class="card">${poolsHtml}</div>`;

  const membersRows = summary.members.map(m=>`
    <tr>
      <td>${m.name} <div class="small">${m.age} tuổi — ${m.role}</div></td>
      <td>${formatVnd(m.essentials)}</td>
      <td>${formatVnd(m.education)}</td>
      <td>${formatVnd(m.essentials+m.education)}</td>
    </tr>`).join('');

  div.innerHTML += `<div class="card">
    <strong>Phân bổ theo thành viên</strong>
    <table>
      <tr><th>Thành viên</th><th>Essentials</th><th>Education</th><th>Tổng</th></tr>
      ${membersRows}
    </table>
  </div>`;

  let analysisHtml='';
  if(essentialsPerPerson>=targetPerPerson){
    analysisHtml=`<div><strong>Chi tiêu cần thiết trung bình đạt mục tiêu: ${formatVnd(Math.round(essentialsPerPerson))} ₫ / người</strong></div>`;
  } else {
    analysisHtml=`<div class="danger"><strong>Chi tiêu cần thiết trung bình (${formatVnd(Math.round(essentialsPerPerson))}) thấp hơn mục tiêu (${formatVnd(targetPerPerson)})</strong></div>
      <div class="small">Thu nhập cần thiết tối thiểu: <strong>${formatVnd(requiredIncome)}</strong> (${pctChange>=0?'+':''}${pctChange}%)</div>`;
  }

  div.innerHTML += `<div class="card"><strong>Phân tích & đề xuất</strong>${analysisHtml}</div>`;

  if(charityTransfer>0){
    div.innerHTML += `<div class="card"><strong>Trích tạm từ Quỹ Từ thiện</strong><div class="small">Đã trích ${formatVnd(Math.round(charityTransfer))} từ Quỹ Từ thiện (tối đa 2% thu nhập) để bù Essentials</div></div>`;
  }
}

// ==== Khởi tạo ====
resetMembers();
</script>

</body>
</html>
